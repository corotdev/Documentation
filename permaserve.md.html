     <meta charset="utf-8" emacsmode="-*- markdown -*-"><link rel="stylesheet" href="./apidoc.css?">

                          **Permaserve API**

## Connection protocol

### Connect to the active ip **/handshake** and pass as headers the following

* user-agent (must contain the user application key)
* client-version (the version of the client in the format X.Y where X is the major version and Y is the minor version [patch excluded]))
* username (will eventually support any auth id field, including email or platform id, for now only supports username)
* token (generate via /auth)

### Request a token to **/auth**
Send an HTTP request to /auth with the following headers:
* user-agent (must contain the user application key)
* username (will eventually support any auth id field, including email or platform id, for now only supports username)
* password

Server will respond with one of these responses:
200 if login is successful
500 if the login failed but the server should retain the cached auth
401 if login failed AND the client should prompt the user to re-enter their login
400 if the client version is outdated and should install the latest update
and if successful, the response body will look like this:
```
{
"token": "6c5f93c9-c25f-4573-8ab0-76e7fbd5a3b4"
}
```
### Request a token to **/register**
Send an HTTP request to /auth with the following headers:
* user-agent (must contain the user application key)
* username (will eventually support any auth id field, including email or platform id, for now only supports username)
* password
* email

Will return 200 if successful, or 400 if unsuccesful.

## client->server messages
     <div class="admonition note">
     Take these properties and their types seriously. Any message sent to the server with an invalid or incorrect datatype, missing required field, or missing type field altogether will result in an IMMEDIATE DISCONNECTION under protocol violation 1002.
     </div>
### `ping`
     <div class="admonition note">
     Not to be confused with server->client ping which is a heartbeat, and expects the client to relay the server's timestamp instead of the other way around.
     </div>
This message prompts the server to respond with a type `ack` message containing the timestamp of the received ping message.
Fields | Required | Type | Description
--- | --- | --- | ---
type | yes | "ping" | The message type
timestamp | yes | `number` | The client-relative timestamp. Will be echoed. If this is sent improperly or as incorrect type, the server will not respond.
Example
```
type=ping
timestamp=123456789
```
Which is responded to by the server with
```
type=ack
message=ping
timestamp=123456789
```

### `pong`
Response to a server `ping` message. Must echo the timestamp field of the received ping message.
Fields | Required | Type | Description
--- | --- | --- | ---
type | yes | "pong" | The message type
timestamp | yes | number | The timestamp provided by the server's ping message. If this is sent improperly or as incorrect type, the server will disconnect the client.
Example
```
type=pong
timestamp=123456789
```
This message must be sent immediately upon receipt of a server `ping` message, or the client connection will be forcefully terminated as a timeout violation.

### `set_position`
     <div class="admonition note">
     This message will soon be deprecated in favor of `update_self`
     </div>

#### Request:

Fields | Required | Type | Description
--- | --- | --- | ---
target | no | `string` | The id of the entity to update (if empty, will infer "self")
x | yes | `number` | The x coordinate of the position
y | yes | `number` | The y coordinate of the position
z | yes | `number` | The z coordinate of the position

#### Broadcast:

Fields | Required | Type | Description
--- | --- | --- | ---
type | "set_position" |
gameobject | gameobject | the updated player gameobject
Example
```
type=setposition
x=123
y=456
z=789
```
-->
Global broadcast
```
type=set_position
gameobject=player gameobject
```
### `auth`
     <div class="admonition note">
     This message is temporarily not checked against the real user database. Extra handling for rejections will need to be added once this is done.
     </div>

#### Request:

Fields | Required | Type | Description
--- | --- | --- | ---
username | yes | `string` | The username of the account
password | yes | `string` | The password of the account

#### Response:

Fields | Type | Description
--- | --- | --- | ---
type | "ack" | The message type to differentiate responses from inbound updates
message | "auth" | The type of message that this response responds to
authed | `boolean` | Whether the authentication succeeded or not
auth | `uuidv4` | Authtoken for client to remember (sent only if successful, currently has no effect)


Example
```
type=auth
username=corotdev
password=verycarroty
```
-->
```
type=ack
message=auth
authed=false
auth=
```

### `update_self`
Fields | Required | Type | Description
--- | --- | --- | ---
dx | no | `double` (meters) | The ∆x change in coordinate of the position
dy | no | `double` (meters) | The ∆y change in coordinate of the position
dz | no | `double` (meters) | The ∆z change in coordinate of the position
vx | no | `double` (m/s) | The new velocity along the x axis
vy | no | `double` (m/s) | The new velocity along the y axis
vz | no | `double` (m/s) | The new velocity along the z axis
rx | no | `double` (deg) | The new rotational position around the x axis
ry | no | `double` (deg) | The new rotational position around the y axis
rz | no | `double` (deg) | The new rotational position around the z axis
sx | no | `double` | The new scale of the entity
sy | no | `double` | The new scale of the entity
sz | no | `double` | The new scale of the entity

Example
```
type=update_self
dx=123
dy=456
dz=789
```

### `send_state`
Request the relevant nearby game object state from the server. The server will respond with a type `state` message containing lists of all fields filled entities, players, stalls, and worlds that the server deems relevant to the client.
<div class="admonition note">
This message should be used sparingly, as it is expensive for the server to process. The client should cache all game objects it receives from the server and only request updates for objects it does not already know about by passing their UUIDs in the `exclude` field. The server will not send any game objects whose UUIDs are included in the `exclude` list.
Try to only send this message when absolutely necessary, such as on initial connection or when the client has moved a significant distance.
Eventually, the server will automatically send state updates to the client as needed, making this message obsolete.
</div>
#### Request:

Fields | Required | Type | Description
--- | --- | --- | ---
exclude | no | `string[]` | A list of UUIDs of game objects the client already knows about and does not need to be sent again.

#### Response:

see `state` message in server->client messages below


Example
```
type=send_state
exclude=uuid1,uuid2,uuid3
```
-->
```
entities=[{entity1},{entity2},...]
players=[{player1},{player2},...]
stalls=[{stall1},{stall2},...]
worlds=[{world1},{world2},...]
```

## server->client messages

### `ping`
Heartbeat message, expects the client to immediately upon receipt respond with a type `pong` message containing the timestamp of the received ping message.
Fields | Type | Description
--- | --- | ---
type | "ping" | The message type to differentiate responses from inbound updates
timestamp | `number` | The server timestamp offset in milliseconds from server start. Not meaningful to client. Must be included as-is in response or client will be disconnected.
ping | `number` or `undefined` | The average of the last 10 round-trip pings as calculated by the server for the client, or undefined if there is no ping data available.

### `ack`
Acknowledgment/Inverted heartbeat message, sent as a response to `ping` message from client. May also be used as a response to other POST-like messages from the client in the future, hence the message field.
Fields | Type | Description
--- | --- | ---
type | "ack" | The message type to differentiate responses from inbound updates
message | "ping"... | The type of message that the server is acknowledging, e.g. "ping" for a ping message
timestamp | `number` | The number provided by the client's initial `ping` message.
### `welcome`
Sent automatically by the server upon initial connection to the client, contains basic information about the player and server state.
Fields | Type | Description
--- | --- | ---
type | "welcome" | The message type to differentiate responses from inbound updates
self | `playerJSON` | The player object representing the client itself.
### `state`
Sent only in response to a `send_state` message from the client, or sent automatically by the server when the client needs content. Contains lists of all relevant game objects the server deems relevant to the client.
Fields | Type | Description
--- | --- | ---
type | "state" | The message type to differentiate responses from inbound updates
entities | `entityJSON[]` or `[]` | A list of all entities the server deems relevant to the client, or an empty list if none are relevant.
players | `playerJSON[]` or `[]` | A list of all players the server deems relevant to the client, or an empty list if none are relevant.
stalls | `stallJSON[]` or `[]` | A list of all stalls the server deems relevant to the client, or an empty list if none are relevant.
worlds | `worldJSON[]` or `[]` | A list of all worlds the server deems relevant to the client, or an empty list if none are relevant.

## Data structures
The shape of these objects is as follows:
### position

#### database model
Fields | Type | Description
--- | --- | --- | ---
origin | `string?` | The UUID of the anchor this position is defined relative to, or undefined/unset if the position is untethered in galactic space (in which case the position specified matches the galactic coordinates).
x | `number` | The x coordinate in meters (if origin is set) or Megameters (for galactic space, to reduce error)
y | `number` | The y coordinate in meters (if origin is set) or Megameters (for galactic space, to reduce error)
z | `number` | The z coordinate in meters (if origin is set) or Megameters (for galactic space, to reduce error)
vx | `number?` | The velocity along the x axis in meters per second
vy | `number?` | The velocity along the y axis in meters per second
vz | `number?` | The velocity along the z axis in meters per second
rx | `number` | The rotation around the x axis in degrees
ry | `number` | The rotation around the y axis in degrees
rz | `number` | The rotation around the z axis in degrees
rvx | `number?` | The rotational velocity around the x axis in degrees per second
rvy | `number?` | The rotational velocity around the y axis in degrees per second
rvz | `number?` | The rotational velocity around the z axis in degrees per second
or | `number` | The orbit radius in meters (for world space) or Megameters (for galactic space)
sx | `number` | The scale along the x axis (1 is default)
sy | `number` | The scale along the y axis (1 is default)
sz | `number` | The scale along the z axis (1 is default)

#### client + server
Fields | Type | Description
--- | --- | --- | ---
origin | `string?` | The UUID of the anchor this position is defined relative to, or undefined/unset if the position is untethered in galactic space (in which case the position specified matches the galactic coordinates).
p | `vector3<Float>` | The coordinates in meters (if origin is set) or Megameters (for galactic space, to reduce error)
v | `vector3<Float>` | The velocity in meters per second
r | `vector3<Float>` | The rotation in degrees
rv | `vector3<Float>` | The rotational velocity in degrees per second
s | `vector3<Float>` | The scale (1 is default)
<div class="admonition note">
vector3<Float> is serialized into JSON as {x: $, y: $, z: $} with three components of x y and z keys, with Float values of type Number replacing the dollar signs.
</div>
@@index([x,y,z])
### entityJSON
Fields | Type | Description
--- | --- | ---
id | `string` | The UUID of the entity
world | `number` | The ID of the world the entity is in (0 for galactic)
anchor | `string` or `undefined` | The UUID of the anchor of the entity, or null if the entity is not anchored to anything.
type | `string` | The type of the entity, e.g. "npc", "item", etc.
position | `position` | The positional, rotational, and scalar information of the entity in world space, in meters, degrees, and scale units respectively.
properties | `{[key: string]: any}` | A dictionary of additional properties specific to the entity type.
### playerJSON
Fields | Type | Description
--- | --- | ---
username | `string` | The username of the player. Use this as the ID field.
world | `number` | The ID of the world the player is in.
anchor | `string` or `undefined` | The UUID of the anchor of the player, or null if the player is not anchored to anything.
position | `position` | The positional, rotational, and scalar information of the player in world space, in meters, degrees, and scale units respectively.
properties | `{[key: string]: any}` | A dictionary of additional properties specific to the player.
### stallJSON
Fields | Type | Description
--- | --- | ---
id | `string` | The UUID of the stall
world | `number` | The ID of the world the stall is in.
type | `string` | The type of the stall, e.g. "counter", "sign", etc.
position | `position` | The positional, rotational, and scalar information of the stall in world space, in meters, degrees, and scale units respectively.
properties | `{[key: string]: any}` | A dictionary of additional properties specific to the stall.
### worldJSON
Fields | Type | Description
--- | --- | ---
id | `number` | The ID of the world
name | `string` | The name of the world
stalls | `string[]` | A list of UUIDs of stalls in the world.
entities | `string[]` | A list of UUIDs of entities in the world.
players | `string[]` | A list of usernames of players in the world.
portal | `string[]` | An array of (almost always) one item, the UUID of the entity in galactic space that serves as the portal to this world. May be more than one in rare cases such as wormholes.
properties | `{[key: string]: any}` | A dictionary of additional properties specific to the world.

<style class="fallback">body{visibility:hidden}</style><script>markdeepOptions={tocStyle:'medium'};</script>
<!-- Markdeep: --><script src="./markdeep.min.js?" charset="utf-8"></script>
