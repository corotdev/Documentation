     <meta charset="utf-8" emacsmode="-*- markdown -*-"><link rel="stylesheet" href="https://casual-effects.com/markdeep/latest/apidoc.css?">

                          **Permaserve API**

## Connection protocol

### Connect to the active ip **/handshake** and pass as headers the following

* user-agent (must contain the user application key)
* client-version (the version of the client in the format X.Y where X is the major version and Y is the minor version [patch excluded]))
* username (will eventually support any auth id field, including email or platform id, for now only supports username)
* token (generate via /auth)

### Request a token to **/auth**
Send an HTTP request to /auth with the following headers:
* user-agent (must contain the user application key)
* username (will eventually support any auth id field, including email or platform id, for now only supports username)
* password

Server will respond with one of these responses:
200 if login is successful
500 if the login failed but the server should retain the cached auth
401 if login failed AND the client should prompt the user to re-enter their login
400 if the client version is outdated and should install the latest update
and if successful, the response body will look like this:
```
{
"token": "6c5f93c9-c25f-4573-8ab0-76e7fbd5a3b4"
}
```
### Request a token to **/register**
Send an HTTP request to /auth with the following headers:
* user-agent (must contain the user application key)
* username (will eventually support any auth id field, including email or platform id, for now only supports username)
* password
* email

Will return 200 if successful, or 400 if unsuccesful.

## client->server messages
     <div class="admonition note">
     Take these properties and their types seriously. Any message sent to the server with an invalid or incorrect datatype, missing required field, or missing type field altogether will result in an IMMEDIATE DISCONNECTION under protocol violation 1002.
     </div>
### `ping`
     <div class="admonition note">
     Not to be confused with server->client ping which is a heartbeat, and expects the client to relay the server's timestamp instead of the other way around.
     </div>
This message prompts the server to respond with a type `ack` message containing the timestamp of the received ping message.
Fields | Required | Type | Description
--- | --- | --- | ---
type | yes | "ping" | The message type
timestamp | yes | `number` | The client-relative timestamp. Will be echoed. If this is sent improperly or as incorrect type, the server will not respond.
Example
```
type=ping
timestamp=123456789
```
Which is responded to by the server with
```
type=ack
message=ping
timestamp=123456789
```

### `pong`
Response to a server `ping` message. Must echo the timestamp field of the received ping message.
Fields | Required | Type | Description
--- | --- | --- | ---
type | yes | "pong" | The message type
timestamp | yes | number | The timestamp provided by the server's ping message. If this is sent improperly or as incorrect type, the server will disconnect the client.
Example
```
type=pong
timestamp=123456789
```
This message must be sent immediately upon receipt of a server `ping` message, or the client connection will be forcefully terminated as a timeout violation.

### `set_position`
     <div class="admonition note">
     This message will soon be deprecated in favor of `update`
     </div>

#### Request:

Fields | Required | Type | Description
--- | --- | --- | ---
target | no | `string` | The id of the entity to update (if empty, will infer "self")
x | yes | `number` | The x coordinate of the position
y | yes | `number` | The y coordinate of the position
z | yes | `number` | The z coordinate of the position

#### Broadcast:

Fields | Required | Type | Description
--- | --- | --- | ---
type | "set_position" |
gameobject | gameobject | the updated player gameobject
Example
```
type=setposition
x=123
y=456
z=789
```
-->
Global broadcast
```
type=set_position
gameobject=player gameobject
```
### `auth`
     <div class="admonition note">
     This message is temporarily not checked against the real user database. Extra handling for rejections will need to be added once this is done.
     </div>

#### Request:

Fields | Required | Type | Description
--- | --- | --- | ---
username | yes | `string` | The username of the account
password | yes | `string` | The password of the account

#### Response:

Fields | Type | Description
--- | --- | --- | ---
type | "ack" | The message type to differentiate responses from inbound updates
message | "auth" | The type of message that this response responds to
authed | `boolean` | Whether the authentication succeeded or not
auth | `uuidv4` | Authtoken for client to remember (sent only if successful, currently has no effect)


Example
```
type=auth
username=corotdev
password=verycarroty
```
-->
```
type=ack
message=auth
authed=false
auth=
```

### `update`
Fields | Required | Type | Description
--- | --- | --- | ---
target | yes | `string` | The id of the entity to update (if empty, will infer "self")
px | no | `double` (meters) | The ∆x change in coordinate of the position
py | no | `double` (meters) | The ∆y change in coordinate of the position
pz | no | `double` (meters) | The ∆z change in coordinate of the position
rx | no | `double` (deg) | The new rotational position around the x axis
ry | no | `double` (deg) | The new rotational position around the y axis
rz | no | `double` (deg) | The new rotational position around the z axis
sx | no | `double` | The new scale of the entity
sy | no | `double` | The new scale of the entity
sz | no | `double` | The new scale of the entity

Example
```
type=setposition
target=self
px=123
py=456
pz=789
```

## server->client messages

### `ping`
Heartbeat message, expects the client to immediately upon receipt respond with a type `pong` message containing the timestamp of the received ping message.
Fields | Type | Description
--- | --- | ---
type | "ping" | The message type to differentiate responses from inbound updates
timestamp | `number` | The server timestamp offset in milliseconds from server start. Not meaningful to client. Must be included as-is in response or client will be disconnected.
ping | `number` or `undefined` | The average of the last 10 round-trip pings as calculated by the server for the client, or undefined if there is no ping data available.

### `ack`
Acknowledgment/Inverted heartbeat message, sent as a response to `ping` message from client. May also be used as a response to other POST-like messages from the client in the future, hence the message field.
Fields | Type | Description
--- | --- | ---
type | "ack" | The message type to differentiate responses from inbound updates
message | "ping"... | The type of message that the server is acknowledging, e.g. "ping" for a ping message
timestamp | `number` | The number provided by the client's initial `ping` message.

<style class="fallback">body{visibility:hidden}</style><script>markdeepOptions={tocStyle:'medium'};</script>
<!-- Markdeep: --><script src="https://casual-effects.com/markdeep/latest/markdeep.min.js?" charset="utf-8"></script>
