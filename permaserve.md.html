     <meta charset="utf-8" emacsmode="-*- markdown -*-"><link rel="stylesheet" href="./apidoc.css?">

                          **Permaserve API**

## Protocol Version

The current protocol version is **0.2**. This version uses semantic versioning:
- **Major version** changes indicate breaking protocol changes (incompatible message formats)
- **Minor version** changes indicate backward-compatible additions (new optional fields or message types)

Both client and server MUST negotiate protocol compatibility during handshake.

## Connection protocol

### Connect to the active ip **/handshake** and pass as headers the following

* user-agent (must contain the user application key)
* protocol-version (the protocol version in format X.Y where X is the major version and Y is the minor version)
* client-version (the version of the client in the format X.Y where X is the major version and Y is the minor version [patch excluded]))
* username (will eventually support any auth id field, including email or platform id, for now only supports username)
* token (generate via /auth)

#### Handshake Response
The server will respond with one of the following:
* **101 Switching Protocols** - Handshake successful, WebSocket connection established
* **426 Upgrade Required** - Client protocol version incompatible (response includes `X-Required-Protocol-Version` header with minimum supported version)
* **401 Unauthorized** - Invalid token or authentication failure
* **400 Bad Request** - Missing required headers or malformed request

On successful handshake (101), the server will send a `welcome` message as the first WebSocket message.

### Request a token to **/auth**
Send an HTTP POST request to /auth with the following headers:
* user-agent (must contain the user application key)
* client-version (the version of the client in format X.Y)
* username (will eventually support any auth id field, including email or platform id, for now only supports username)
* password

#### Response Codes and Bodies:

**200 OK** - Authentication successful
```json
{
  "token": "6c5f93c9-c25f-4573-8ab0-76e7fbd5a3b4",
  "username": "corotdev",
  "expires_at": 1704758400000
}
```

**401 Unauthorized** - Invalid credentials, client should prompt user to re-enter
```json
{
  "error": "INVALID_CREDENTIALS",
  "message": "Username or password incorrect",
  "retry_allowed": true
}
```

**400 Bad Request** - Malformed request (missing headers, invalid format)
```json
{
  "error": "BAD_REQUEST",
  "message": "Missing required header: username",
  "field": "username"
}
```

**426 Upgrade Required** - Client version outdated, must update
```json
{
  "error": "CLIENT_OUTDATED",
  "message": "Client version 0.1 is no longer supported. Minimum version: 0.2",
  "minimum_version": "1.5",
  "download_url": "https://example.com/download"
}
```

**429 Too Many Requests** - Rate limit exceeded
```json
{
  "error": "RATE_LIMIT_EXCEEDED",
  "message": "Too many authentication attempts. Please wait before trying again.",
  "retry_after": 60
}
```

**503 Service Unavailable** - Server temporarily unavailable (maintenance, overload)
```json
{
  "error": "SERVICE_UNAVAILABLE",
  "message": "Authentication service temporarily unavailable. Please try again later.",
  "retry_after": 120
}
```

**Note:** The old 500 status code for "server should retain cached auth" has been deprecated. Clients should implement local token caching and only re-authenticate when receiving 401 or on token expiration.
### Request a token to **/register**
Send an HTTP POST request to /register with the following headers:
* user-agent (must contain the user application key)
* client-version (the version of the client in format X.Y)
* username (will eventually support any auth id field, including email or platform id, for now only supports username)
* password
* email

#### Response Codes and Bodies:

**201 Created** - Registration successful (changed from 200 to follow HTTP semantics)
```json
{
  "token": "6c5f93c9-c25f-4573-8ab0-76e7fbd5a3b4",
  "username": "newuser",
  "expires_at": 1704758400000
}
```

**400 Bad Request** - Malformed request or validation error
```json
{
  "error": "VALIDATION_ERROR",
  "message": "Username already exists",
  "field": "username"
}
```
Additional validation error codes in `error` field:
- `USERNAME_TAKEN` - Username already registered
- `EMAIL_TAKEN` - Email already registered
- `INVALID_EMAIL` - Email format invalid
- `WEAK_PASSWORD` - Password doesn't meet security requirements
- `INVALID_USERNAME` - Username contains invalid characters or is too short/long

**426 Upgrade Required** - Client version outdated
```json
{
  "error": "CLIENT_OUTDATED",
  "message": "Client version 0.1 is no longer supported. Minimum version: 0.2",
  "minimum_version": "0.2",
  "download_url": "https://github.com/corotdev/pvdl/releases/latest"
}
```

**429 Too Many Requests** - Rate limit exceeded
```json
{
  "error": "RATE_LIMIT_EXCEEDED",
  "message": "Too many registration attempts. Please wait before trying again.",
  "retry_after": 300
}
```

**503 Service Unavailable** - Server temporarily unavailable
```json
{
  "error": "SERVICE_UNAVAILABLE",
  "message": "Registration service temporarily unavailable. Please try again later.",
  "retry_after": 120
}
```

## Connection State Machine

The protocol enforces a state machine for connection lifecycle:

State | Allowed Client Messages | Server Behavior
--- | --- | ---
**CONNECTING** | None | Handshake in progress
**CONNECTED** | All messages allowed | Normal operation, full message processing
**AUTHENTICATED** | All messages allowed | (Future state when auth is enforced)
**DISCONNECTING** | `disconnect` only | Grace period before close
**CLOSED** | None | Connection terminated

#### State Transitions

```
CONNECTING --[handshake success]--> CONNECTED
CONNECTED --[client disconnect]--> DISCONNECTING
DISCONNECTING --[5 seconds]--> CLOSED
CONNECTED --[timeout/error]--> CLOSED
```

Messages sent in wrong state result in immediate disconnection or are ignored.

## Message Size and Rate Limits

### Size Limits

* **Maximum message size**: 16 KB (16,384 bytes) per WebSocket message
* **Messages exceeding limit**: Rejected with `error` code 1007, counts as 1 violation point
* **Recommendation**: Clients should batch updates efficiently to stay under limit

### Rate Limits

* **Maximum message rate**: 100 messages per second (averaged over 10-second window)
* **Burst allowance**: Up to 200 messages in 1 second, but must average to ≤100/sec over 10 seconds
* **Rate limit exceeded**: Server sends `error` code 1004, subsequent messages within same second are dropped
* **Critical rate violation**: >500 messages in 1 second results in immediate disconnection (code 1008)

These limits prevent accidental client bugs or malicious behavior from degrading server performance.

## client->server messages
     <div class="admonition note">
     Take these properties and their types seriously. Any message sent to the server with an invalid or incorrect datatype, missing required field, or missing type field altogether will result in an IMMEDIATE DISCONNECTION under protocol violation 1002.
     </div>
### `ping`
     <div class="admonition note">
     Not to be confused with server->client ping which is a heartbeat, and expects the client to relay the server's timestamp instead of the other way around.
     </div>
This message prompts the server to respond with a type `ack` message containing the timestamp of the received ping message.
Fields | Required | Type | Description
--- | --- | --- | ---
type | yes | "ping" | The message type
timestamp | yes | `number` | The client-relative timestamp. Will be echoed. If this is sent improperly or as incorrect type, the server will not respond.
Example
```
type=ping
timestamp=123456789
```
Which is responded to by the server with
```
type=ack
message=ping
timestamp=123456789
```

### `pong`
Response to a server `ping` message. Must echo the timestamp field of the received ping message.

Fields | Required | Type | Description
--- | --- | --- | ---
type | yes | "pong" | The message type
timestamp | yes | number | The timestamp provided by the server's ping message. If this is sent improperly or as incorrect type, the server will disconnect the client.

Example
```
type=pong
timestamp=123456789
```

#### Heartbeat Timing Requirements

* **Server ping interval**: Server sends `ping` messages every **30 seconds** of connection inactivity (no messages from client).
* **Client pong deadline**: Client MUST respond with `pong` within **10 seconds** of receiving a `ping`.
* **Grace period**: After timeout, server waits an additional **5 seconds** grace period before disconnecting.
* **Disconnection**: If no `pong` is received within 15 seconds total (10s deadline + 5s grace), server disconnects with code 1001 (Going Away) and reason "Heartbeat timeout".

This allows clients on slow or unstable connections to maintain their session while detecting truly dead connections.

### `update_self`
Fields | Required | Type | Description
--- | --- | --- | ---
dx | no | `double` (meters) | The ∆x change in coordinate of the position
dy | no | `double` (meters) | The ∆y change in coordinate of the position
dz | no | `double` (meters) | The ∆z change in coordinate of the position
vx | no | `double` (m/s) | The new velocity along the x axis
vy | no | `double` (m/s) | The new velocity along the y axis
vz | no | `double` (m/s) | The new velocity along the z axis
rx | no | `double` (deg) | The new rotational position around the x axis
ry | no | `double` (deg) | The new rotational position around the y axis
rz | no | `double` (deg) | The new rotational position around the z axis
sx | no | `double` | The new scale of the entity
sy | no | `double` | The new scale of the entity
sz | no | `double` | The new scale of the entity

Example
```
type=update_self
dx=123
dy=456
dz=789
```

## server->client messages

### `ping`
Heartbeat message sent every 30 seconds of connection inactivity. Client must respond with `pong` within 10 seconds or risk disconnection.

Fields | Type | Description
--- | --- | ---
type | "ping" | The message type to differentiate responses from inbound updates
timestamp | `number` | The server timestamp offset in milliseconds from server start. Not meaningful to client. Must be included as-is in response or client will be disconnected.
ping | `number` or `undefined` | The average of the last 10 round-trip pings as calculated by the server for the client, or undefined if there is no ping data available.
deadline | `number` | Timestamp (milliseconds since epoch) by which the client must respond with `pong`. Calculated as current time + 10000ms.

Example:
```
type=ping
timestamp=123456789
ping=45.2
deadline=1704672010000
```

### `ack`
Acknowledgment/Inverted heartbeat message, sent as a response to `ping` message from client. May also be used as a response to other POST-like messages from the client in the future, hence the message field.
Fields | Type | Description
--- | --- | ---
type | "ack" | The message type to differentiate responses from inbound updates
message | "ping"... | The type of message that the server is acknowledging, e.g. "ping" for a ping message
timestamp | `number` | The number provided by the client's initial `ping` message.

### `welcome`
Sent automatically by the server upon initial connection to the client, contains basic information about the player and server state.

Fields | Type | Description
--- | --- | ---
type | "welcome" | The message type to differentiate responses from inbound updates
self | `playerJSON` | The player object representing the client itself.
### `state`
Sent automatically by the server when the client needs updated game object information. The server maintains a cache of which game objects each client already knows about and only sends new or updated objects that the client hasn't received yet. This message is triggered by client movement, world changes, or when nearby objects are created/modified.
<div class="admonition note">
The server tracks which game objects (entities, players, stalls, and worlds) have been sent to each client. Only objects that are newly relevant or have been updated since the client last received them will be included in state updates. This eliminates the need for clients to manually manage exclusion lists or request state.
</div>
Fields | Type | Description
--- | --- | ---
type | "state" | The message type to differentiate responses from inbound updates
entities | `entityJSON[]` or `[]` | A list of entities newly relevant to the client or that have been updated, or an empty list if none.
players | `playerJSON[]` or `[]` | A list of players newly relevant to the client or that have been updated, or an empty list if none.
stalls | `stallJSON[]` or `[]` | A list of stalls newly relevant to the client or that have been updated, or an empty list if none.
worlds | `worldJSON[]` or `[]` | A list of worlds newly relevant to the client or that have been updated, or an empty list if none.

Example
```
type=state
entities=[{entity1},{entity2}]
players=[{player1}]
stalls=[]
worlds=[{world1}]
```

## Reconnection and Session Recovery

### Connection Loss Handling

When a WebSocket connection is lost (network failure, timeout, server restart), clients should implement the following reconnection strategy:

#### Reconnection Backoff Algorithm

Attempt | Delay Before Retry | Notes
--- | --- | ---
1 | Immediate (0s) | First reconnection attempt is immediate
2 | 1 second | Quick retry for transient issues
3 | 2 seconds |
4 | 4 seconds |
5 | 8 seconds |
6+ | 16 seconds | Maximum backoff cap, repeat indefinitely or until user intervention

**Backoff calculation**: `min(2^(attempt-1), 16)` seconds

**Jitter**: Add random jitter of ±20% to prevent thundering herd when server recovers.

### Session Recovery

The server maintains session state for **5 minutes** after unexpected disconnection (timeout, network error). Session is identified by auth token.

#### Session State Preservation

During the 5-minute window, the server preserves:
* Player position and world
* Accumulated game state

#### Reconnection with Session Resume

To resume a session, include the `resume-session` header during handshake:

```
resume-session: true
```

**Server responses:**

* **Session resumed successfully**: Connection proceeds normally and client receives current state
* **Session expired**: Client starts with fresh connection and receives full initial state

### Graceful Disconnection

When client intentionally disconnects, it should send a `disconnect` message before closing WebSocket:

```
type=disconnect
reason=user_requested
```

This immediately clears server-side session state and prevents unnecessary 5-minute session preservation.

Server will respond with WebSocket close code 1000 (Normal Closure).

## WebSocket Close Codes

When disconnecting, the server uses standard WebSocket close codes:

Code | Name | When Used
--- | --- | ---
1000 | Normal Closure | Client sent disconnect message or graceful shutdown
1001 | Going Away | Heartbeat timeout or server shutdown
1002 | Protocol Error | Protocol violation (invalid message format, missing required fields, incorrect types)
1008 | Policy Violation | Critical violation (malicious payload, extreme rate limit)
1011 | Internal Error | Unexpected server error during message processing

Clients can inspect the close code to determine reconnection strategy (e.g., don't auto-reconnect on 1002, do reconnect on 1001).

## Data structures
The shape of these objects is as follows:
### position

#### database model
<div class="admonition note">
This model describes how the data is stored in the database. To see how it is implemented in code, scroll down to the heading `client + server` </div>
Fields | Type | Description
--- | --- | --- | ---
parent | `String` or `"origin"` | The UUID of the anchor this position is defined relative to, or `"origin"` if the position is untethered in galactic space (in which case the position specified matches the galactic coordinates).
x | `Float` | The x coordinate in meters (if origin is set) or Megameters (for galactic space, to reduce error)
y | `Float` | The y coordinate in meters (if origin is set) or Megameters (for galactic space, to reduce error)
z | `Float` | The z coordinate in meters (if origin is set) or Megameters (for galactic space, to reduce error)
vx | `Float` | The velocity along the x axis in meters per second
vy | `Float` | The velocity along the y axis in meters per second
vz | `Float` | The velocity along the z axis in meters per second
rx | `Float` | The rotation around the x axis in degrees
ry | `Float` | The rotation around the y axis in degrees
rz | `Float` | The rotation around the z axis in degrees
rvx | `Float` | The rotational velocity around the x axis in degrees per second
rvy | `Float` | The rotational velocity around the y axis in degrees per second
rvz | `Float` | The rotational velocity around the z axis in degrees per second
sx | `Float` | The scale along the x axis (1 is default)
sy | `Float` | The scale along the y axis (1 is default)
sz | `Float` | The scale along the z axis (1 is default)
@@index([x,y,z])

#### client + server
Fields | Type | Description
--- | --- | --- | ---
parent | `string?` | The UUID of the anchor this position is defined relative to, or `undefined` if the position is untethered in galactic space (in which case the position specified matches the galactic coordinates).
p | `vector3<Float>` | The coordinates in meters (if origin is set) or Megameters (for galactic space, to reduce error)
v | `vector3<Float>` | The velocity in meters per second
r | `vector3<Float>` | The rotation in degrees
rv | `vector3<Float>` | The rotational velocity in degrees per second
s | `vector3<Float>` | The scale (1 is default)
<div class="admonition note">
vector3<Float> is serialized into JSON as `{x: $, y: $, z: $}`, with three components of x y and z keys, and with Float values of type Number replacing the dollar signs.
</div>

### entityJSON
Fields | Type | Description
--- | --- | ---
id | `string` | The UUID of the entity
world | `number` | The ID of the world the entity is in (0 for galactic)
anchor | `string` or `undefined` | The UUID of the anchor of the entity, or null if the entity is not anchored to anything.
type | `string` | The type of the entity, e.g. "npc", "item", etc.
position | `position` | The positional, rotational, and scalar information of the entity in world space, in meters, degrees, and scale units respectively.
properties | `{[key: string]: any}` | A dictionary of additional properties specific to the entity type.
### playerJSON
Fields | Type | Description
--- | --- | ---
username | `string` | The username of the player. Use this as the ID field.
world | `number` | The ID of the world the player is in.
anchor | `string` or `undefined` | The UUID of the anchor of the player, or null if the player is not anchored to anything.
position | `position` | The positional, rotational, and scalar information of the player in world space, in meters, degrees, and scale units respectively.
properties | `{[key: string]: any}` | A dictionary of additional properties specific to the player.
### stallJSON
Fields | Type | Description
--- | --- | ---
id | `string` | The UUID of the stall
world | `number` | The ID of the world the stall is in.
type | `string` | The type of the stall, e.g. "counter", "sign", etc.
position | `position` | The positional, rotational, and scalar information of the stall in world space, in meters, degrees, and scale units respectively.
properties | `{[key: string]: any}` | A dictionary of additional properties specific to the stall.
### worldJSON
Fields | Type | Description
--- | --- | ---
id | `number` | The ID of the world
name | `string` | The name of the world
stalls | `string[]` | A list of UUIDs of stalls in the world.
entities | `string[]` | A list of UUIDs of entities in the world.
players | `string[]` | A list of usernames of players in the world.
portal | `string[]` | An array of (almost always) one item, the UUID of the entity in galactic space that serves as the portal to this world. May be more than one in rare cases such as wormholes.
properties | `{[key: string]: any}` | A dictionary of additional properties specific to the world.

<style class="fallback">body{visibility:hidden}</style><script>markdeepOptions={tocStyle:'medium'};</script>
<!-- Markdeep: --><script src="./markdeep.min.js?" charset="utf-8"></script>
